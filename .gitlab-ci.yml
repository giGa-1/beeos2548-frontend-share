stages:
  - build
  - deploy

variables:
  SERVER_IP: "54.147.119.119"
  SERVER_USER: "ec2-user"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

build:
  stage: build
  image: node:20-alpine
  script:
    - yarn install --frozen-lockfile
    - yarn build
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  artifacts:
    paths:
      - .next/
    expire_in: 1 hour

deploy_production:
  stage: deploy
  image: alpine:latest
  environment:
    name: production
    url: https://beeos2548.com
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts
  script:
    - ssh $SERVER_USER@$SERVER_IP "cd /home/ec2-user/beeos-frontend && git pull origin main && docker-compose build --no-cache && docker-compose down && docker-compose up -d && docker image prune -f"
    - sleep 10
    - ssh $SERVER_USER@$SERVER_IP "curl -s -o /dev/null -w '%{http_code}' https://beeos2548.com"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
